!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["video-stream-merger"]=e():t["video-stream-merger"]=e()}(this,(function(){return function(){var t={650:function(t,e){!function(t){"use strict";var e,i=void 0===Number.MAX_SAFE_INTEGER?9007199254740991:Number.MAX_SAFE_INTEGER,n=536870912,o=1073741824,s=new WeakMap,r=function(t,e){return function(s){var r=e.get(s),a=void 0===r?s.size:r<o?r+1:0;if(!s.has(a))return t(s,a);if(s.size<n){for(;s.has(a);)a=Math.floor(Math.random()*o);return t(s,a)}if(s.size>i)throw new Error("Congratulations, you created a collection of unique numbers which uses all available integers!");for(;s.has(a);)a=Math.floor(Math.random()*i);return t(s,a)}}((e=s,function(t,i){return e.set(t,i),i}),s),a=function(t){return function(e){var i=t(e);return e.add(i),i}}(r);t.addUniqueNumber=a,t.generateUniqueNumber=r,Object.defineProperty(t,"__esModule",{value:!0})}(e)}},e={};function i(n){var o=e[n];if(void 0!==o)return o.exports;var s=e[n]={exports:{}};return t[n].call(s.exports,s,s.exports,i),s.exports}i.d=function(t,e){for(var n in e)i.o(e,n)&&!i.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var n={};return function(){"use strict";i.r(n),i.d(n,{VideoStreamMerger:function(){return s}});var t=i(650);let e=null;const o=()=>{if(null!==e)return e;const i=new Blob(['(()=>{"use strict";const e=new Map,t=new Map,r=(e,t)=>{let r,o;const i=performance.now();r=i,o=e-Math.max(0,i-t);return{expected:r+o,remainingDelay:o}},o=(e,t,r,i)=>{const s=performance.now();s>r?postMessage({id:null,method:"call",params:{timerId:t,timerType:i}}):e.set(t,setTimeout(o,r-s,e,t,r,i))};addEventListener("message",(({data:i})=>{try{if("clear"===i.method){const{id:r,params:{timerId:o,timerType:s}}=i;if("interval"===s)(t=>{const r=e.get(t);if(void 0===r)throw new Error(\'There is no interval scheduled with the given id "\'.concat(t,\'".\'));clearTimeout(r),e.delete(t)})(o),postMessage({error:null,id:r});else{if("timeout"!==s)throw new Error(\'The given type "\'.concat(s,\'" is not supported\'));(e=>{const r=t.get(e);if(void 0===r)throw new Error(\'There is no timeout scheduled with the given id "\'.concat(e,\'".\'));clearTimeout(r),t.delete(e)})(o),postMessage({error:null,id:r})}}else{if("set"!==i.method)throw new Error(\'The given method "\'.concat(i.method,\'" is not supported\'));{const{params:{delay:s,now:n,timerId:a,timerType:d}}=i;if("interval"===d)((t,i,s)=>{const{expected:n,remainingDelay:a}=r(t,s);e.set(i,setTimeout(o,a,e,i,n,"interval"))})(s,a,n);else{if("timeout"!==d)throw new Error(\'The given type "\'.concat(d,\'" is not supported\'));((e,i,s)=>{const{expected:n,remainingDelay:a}=r(e,s);t.set(i,setTimeout(o,a,t,i,n,"timeout"))})(s,a,n)}}}}catch(e){postMessage({error:{message:e.message},id:i.id,result:null})}}))})();'],{type:"application/javascript; charset=utf-8"}),n=URL.createObjectURL(i);return e=(e=>{const i=new Map([[0,()=>{}]]),n=new Map([[0,()=>{}]]),o=new Map,s=new Worker(e);return s.addEventListener("message",(({data:t})=>{if(void 0!==(e=t).method&&"call"===e.method){const{params:{timerId:e,timerType:s}}=t;if("interval"===s){const t=i.get(e);if("number"==typeof t){const i=o.get(t);if(void 0===i||i.timerId!==e||i.timerType!==s)throw new Error("The timer is in an undefined state.")}else{if(void 0===t)throw new Error("The timer is in an undefined state.");t()}}else if("timeout"===s){const t=n.get(e);if("number"==typeof t){const i=o.get(t);if(void 0===i||i.timerId!==e||i.timerType!==s)throw new Error("The timer is in an undefined state.")}else{if(void 0===t)throw new Error("The timer is in an undefined state.");t(),n.delete(e)}}}else{if(!(t=>null===t.error&&"number"==typeof t.id)(t)){const{error:{message:e}}=t;throw new Error(e)}{const{id:e}=t,s=o.get(e);if(void 0===s)throw new Error("The timer is in an undefined state.");const{timerId:r,timerType:a}=s;o.delete(e),"interval"===a?i.delete(r):n.delete(r)}}var e})),{clearInterval:e=>{const n=(0,t.generateUniqueNumber)(o);o.set(n,{timerId:e,timerType:"interval"}),i.set(e,n),s.postMessage({id:n,method:"clear",params:{timerId:e,timerType:"interval"}})},clearTimeout:e=>{const i=(0,t.generateUniqueNumber)(o);o.set(i,{timerId:e,timerType:"timeout"}),n.set(e,i),s.postMessage({id:i,method:"clear",params:{timerId:e,timerType:"timeout"}})},setInterval:(e,n)=>{const o=(0,t.generateUniqueNumber)(i);return i.set(o,(()=>{e(),"function"==typeof i.get(o)&&s.postMessage({id:null,method:"set",params:{delay:n,now:performance.now(),timerId:o,timerType:"interval"}})})),s.postMessage({id:null,method:"set",params:{delay:n,now:performance.now(),timerId:o,timerType:"interval"}}),o},setTimeout:(e,i)=>{const o=(0,t.generateUniqueNumber)(n);return n.set(o,e),s.postMessage({id:null,method:"set",params:{delay:i,now:performance.now(),timerId:o,timerType:"timeout"}}),o}}})(n),e.setTimeout((()=>URL.revokeObjectURL(n)),0),e};class s{constructor(t){this.width=720,this.height=405,this.fps=25,this._streams=[],this._frameCount=0,this.clearRect=!0,this.started=!1,this.result=null,this.supported=null,this._canvas=null,this._ctx=null,this._videoSyncDelayNode=null,this._audioDestination=null,this._audioCtx=null,this._animationFrame=null;const e=window.AudioContext||window.webkitAudioContext,i=!(!window.AudioContext||!(new e).createMediaStreamDestination),n=!!document.createElement("canvas").captureStream;if(!(this.supported=i&&n))return;this.setOptions(t);const o=this._audioCtx=new e,s=this._audioDestination=null==o?void 0:o.createMediaStreamDestination();this._videoSyncDelayNode=o.createDelay(5),this._videoSyncDelayNode.connect(s),this._setupConstantNode(),this.started=!1,this.result=null,this._backgroundAudioHack()}setOptions(t){t=t||{},this._audioCtx=t.audioContext||new AudioContext,this.width=t.width||this.width,this.height=t.height||this.width,this.fps=t.fps||this.fps,this.clearRect=void 0===t.clearRect||t.clearRect}setOutputSize(t,e){this.width=t,this.height=e,this._canvas&&(this._canvas.setAttribute("width",this.width.toString()),this._canvas.setAttribute("height",this.height.toString()))}getAudioContext(){return this._audioCtx}getAudioDestination(){return this._audioDestination}getCanvasContext(){return this._ctx}_backgroundAudioHack(){if(this._audioCtx){const t=this._createConstantSource(),e=this._audioCtx.createGain();e&&t&&(e.gain.value=.001,t.connect(e),e.connect(this._audioCtx.destination),t.start())}}_setupConstantNode(){if(this._audioCtx&&this._videoSyncDelayNode){const t=this._createConstantSource();if(t){t.start();const e=this._audioCtx.createGain();e.gain.value=0,t.connect(e),e.connect(this._videoSyncDelayNode)}}}_createConstantSource(){if(this._audioCtx){if(this._audioCtx.createConstantSource)return this._audioCtx.createConstantSource();const t=this._audioCtx.createBufferSource(),e=this._audioCtx.createBuffer(1,1,this._audioCtx.sampleRate);return e.getChannelData(0)[0]=10,t.buffer=e,t.loop=!0,t}}updateIndex(t,e){"string"==typeof t&&(t={id:t}),e=null==e?0:e;for(let i=0;i<this._streams.length;i++)t.id===this._streams[i].id&&(this._streams[i].index=e);this._sortStreams()}_sortStreams(){this._streams=this._streams.sort(((t,e)=>t.index-e.index))}addMediaElement(t,e,i){if((i=i||{}).x=i.x||0,i.y=i.y||0,i.width=i.width||this.width,i.height=i.height||this.height,i.mute=i.mute||i.muted||!1,i.oldDraw=i.draw,i.oldAudioEffect=i.audioEffect,e instanceof HTMLVideoElement||e instanceof HTMLImageElement?i.draw=(t,n,o)=>{if(i.oldDraw)i.oldDraw(t,e,o);else{const n=null==i.width?this.width:i.width,s=null==i.height?this.height:i.height;t.drawImage(e,i.x,i.y,n,s),o()}}:i.draw=null,this._audioCtx&&!i.mute){const t=e._mediaElementSource||this._audioCtx.createMediaElementSource(e);e._mediaElementSource=t,t.connect(this._audioCtx.destination);const n=this._audioCtx.createGain();t.connect(n),(e instanceof HTMLVideoElement||e instanceof HTMLAudioElement)&&e.muted?(e.muted=!1,e.volume=.001,n.gain.value=1e3):n.gain.value=1,i.audioEffect=(t,e)=>{i.oldAudioEffect?i.oldAudioEffect(n,e):n.connect(e)},i.oldAudioEffect=null}this.addStream(t,i)}addStream(t,e){if("string"==typeof t)return this._addData(t,e);e=e||{};const i={isData:!1};i.x=e.x||0,i.y=e.y||0,i.width=e.width,i.height=e.height,i.draw=e.draw||null,i.mute=e.mute||e.muted||!1,i.audioEffect=e.audioEffect||null,i.index=null==e.index?0:e.index,i.keepRatio=null!=e.keepRatio,i.hasVideo=t.getVideoTracks().length>0,i.hasAudio=t.getAudioTracks().length>0;let n=null;for(let e=0;e<this._streams.length;e++)this._streams[e].id===t.id&&(n=this._streams[e].element);n||(n=document.createElement("video"),n.autoplay=!0,n.muted=!0,n.playsInline=!0,n.srcObject=t,n.setAttribute("style","position:fixed; left: 0px; top:0px; pointer-events: none; opacity:0;"),document.body.appendChild(n),n.play().catch(null),i.hasAudio&&this._audioCtx&&!i.mute&&(i.audioSource=this._audioCtx.createMediaStreamSource(t),i.audioOutput=this._audioCtx.createGain(),i.audioOutput.gain.value=1,i.audioEffect?i.audioEffect(i.audioSource,i.audioOutput):i.audioSource.connect(i.audioOutput),i.audioOutput.connect(this._videoSyncDelayNode))),i.element=n,i.id=t.id||null,this._streams.push(i),this._sortStreams()}removeStream(t){"string"==typeof t&&(t={id:t});for(let e=0;e<this._streams.length;e++){const i=this._streams[e];t.id===i.id&&(i.audioSource&&(i.audioSource=null),i.audioOutput&&(i.audioOutput.disconnect(this._videoSyncDelayNode),i.audioOutput=null),i.element&&i.element.remove(),this._streams[e]=null,this._streams.splice(e,1),e--)}}_addData(t,e){e=e||{};const i={isData:!0};i.draw=e.draw||null,i.audioEffect=e.audioEffect||null,i.id=t,i.element=null,i.index=null==e.index?0:e.index,this._videoSyncDelayNode&&this._audioCtx&&i.audioEffect&&(i.audioOutput=this._audioCtx.createGain(),i.audioOutput.gain.value=1,i.audioEffect(null,i.audioOutput),i.audioOutput.connect(this._videoSyncDelayNode)),this._streams.push(i),this._sortStreams()}_requestAnimationFrame(t){return e=t,1e3/60,o().setTimeout(e,16.666666666666668);var e}_cancelAnimationFrame(t){return e=t,o().clearTimeout(e);var e}start(){var t,e,i,n,o,s;null===(t=this._audioCtx)||void 0===t||t.resume(),this._canvas=document.createElement("canvas"),this._canvas.setAttribute("width",this.width.toString()),this._canvas.setAttribute("height",this.height.toString()),this._canvas.setAttribute("style","position:fixed; left: 110%; pointer-events: none"),this._ctx=this._canvas.getContext("2d"),this.started=!0,this._animationFrame=this._requestAnimationFrame(this._draw.bind(this)),this.result=(null===(e=this._canvas)||void 0===e?void 0:e.captureStream(this.fps))||null;const r=null===(i=this.result)||void 0===i?void 0:i.getAudioTracks()[0];r&&(null===(n=this.result)||void 0===n||n.removeTrack(r));const a=null===(o=this._audioDestination)||void 0===o?void 0:o.stream.getAudioTracks();a&&a.length&&(null===(s=this.result)||void 0===s||s.addTrack(a[0]))}_updateAudioDelay(t){this._videoSyncDelayNode&&this._audioCtx&&this._videoSyncDelayNode.delayTime.setValueAtTime(t/1e3,this._audioCtx.currentTime)}_draw(){var t;if(!this.started)return;this._frameCount++;let e=0;this._frameCount%60==0&&(e=performance.now());let i=this._streams.length;const n=()=>{if(i--,i<=0){if(this._frameCount%60==0){const t=performance.now();this._updateAudioDelay(t-e)}this._requestAnimationFrame(this._draw.bind(this))}};this.clearRect&&(null===(t=this._ctx)||void 0===t||t.clearRect(0,0,this.width,this.height)),this._streams.forEach((t=>{t.draw?t.draw(this._ctx,t.element,n):!t.isData&&t.hasVideo?(this._drawVideo(t.element,t),n()):n()})),0===this._streams.length&&n()}_drawVideo(t,e){var i,n;const o=this.height,s=this.width;if(e.keepRatio){const n=e.height||t.videoHeight||o,r=e.width||t.videoWidth||s,a=Math.min(o/n,s/r),d=(s-r*a)/2,u=(o-n*a)/2;try{null===(i=this._ctx)||void 0===i||i.drawImage(t,0,0,r,n,d,u,r*a,n*a)}catch(t){console.error(t)}}else{const i=e.height||o,r=e.width||s,a=e.x||0,d=e.y||0;try{null===(n=this._ctx)||void 0===n||n.drawImage(t,a,d,r,i)}catch(t){console.error(t)}}}stop(){var t,e;this.started=!1,this._canvas=null,this._ctx=null,this._streams.forEach((t=>{t.element&&t.element.remove()})),this._streams=[],null===(t=this._audioCtx)||void 0===t||t.suspend(),this._animationFrame&&(this._cancelAnimationFrame(this._animationFrame),this._animationFrame=null),null===(e=this.result)||void 0===e||e.getTracks().forEach((t=>{t.stop()})),this.result=null}destroy(){var t;null===(t=this._audioCtx)||void 0===t||t.close(),this._audioCtx=null,this._audioDestination=null,this._videoSyncDelayNode=null,this.stop()}}"undefined"!=typeof window&&(window.VideoStreamMerger=s)}(),n}()}));